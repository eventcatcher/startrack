Doku Falcon XBIOS-Routinen der Startrack-Karte, stand 18.11.97

Alle Cookies werden beim Start auf die Werte des Falcon-TOS gesetzt.
Ebenso wird ein TOS 4.04 vorgeschwindelt (sysbase-VerÑnderung bei $4F2).
Dieser TOS-Emulationsmode ist nun auch abschaltbar. Siehe hierfÅr die
Funktion "compatible" im NEWSYS.TXT. Der Emulationsmode wurde eingebaut,
um Programme die normalerweise nur auf Falcon-Rechnern lÑuft, zur
"Zusammenarbeit" zu Åberreden.

- locksnd: wird voll unterstÅtzt

- unlocksnd: wird voll unterstÅtzt

- soundcmd: Die Einstellungen von LTATTEN,RTATTEN,LTGAIN und RTGAIN werden unterstÅtzt.
            Dabei ist momentan der Ausgangspunkt 0dB. Der Falcon bietet nur 16 Abstufungen
            und nur AbschwÑchung am Ausgang und VerstÑrkung am Eingang. Besser ist es
            auf jeden Fall die Volume-Controller direkt Åber die speziellen XBIOS-Funktionen
            volad(50) und volda(51) anzusprechen, da diese VerstÑrkung und AbschwÑchung in je
            256 Stufen fÅr Eingang UND Ausgang bieten.
            
            ADDRIN wird nicht unterstÅtzt, da die Hardware der verwendeten D/A-Wandler
            dies nicht unterstÅtzt (Hardwareaddierer findet man nur in CODECs).
            Falls ein DSP-Programm dieses Feature verwendet,muû das DSP-Programm
            dahingehend angepaût werden, das die DSP-Eingangsquelle digital zum Ausgang
            (mit ADD-Befehl) hinzugemischt wird um so im Endeffekt das gleiche Resultat zu erzielen.
            
            ADCINPUT hat derzeit keine Funktion, es wird immer der Analog- oder Digitaleingang benutzt.
            Ein Soundchipanschluû ist auf der StarTrack-Karte nicht vorhanden und wird daher
            nicht unterstÅtzt. Man kann den Analog- oder Digitaleingang mit der neuen XBIOS-Funktion
            "digana" auswÑhlen.
            
            SETPRESCALE wird nicht unterstÅtzt da die angegebenen Taktteiler nicht vorhanden sind.
            
- setbuffer: wird voll unterstÅtzt

- setsndmode: wird voll unterstÅtzt

- settrack: wird unterstÅtzt. Die Funktionsweise hÑngt aber vom Aufnahme- und Wiedergabemodus ab, der
  durch die XBIOS-Funktionen recmode(26) und playmode(27) bestimmt wird.
  Nach dem laden des XBIOS-Treibers SOUND.PRG ist der Stereomodus(0) aktiv, d.h. die Angabe
  von settrack wird hier ignoriert. Der Achtkanalmode ist nun in buffoper eingebunden,
  der 4Kanal- und 16Kanal-Mode ist noch nicht implementiert. Die Falcon-Programme kennen
  aber sowieso nur den Achtkanalmode, funktionieren teilweise aber auch im Stereomode
  (solange der DSP nicht genutzt wird).
  
- setmontrack: wird unterstÅtzt, hat aber nur im Acht- oder 16Kanalmodus eine Auswirkung.
  Im Stereomodus wird die Angabe ignoriert.
  
- setinterrupt: wird unterstÅtzt, funktioniert aber etwas anders.
  Da die StarTrack-Audiokarte Åber den VME-Bus angeschlossen wird, besteht keine
  Mîglichkeit nach einem BufferÅberlauf einen MFP-INT Level15 Åber die MFP-Leitung IO7
  zu erzeugen. Daher wird bei jedem buffoper-Aufruf der Inhalt der Interruptvektoren
  von DMA-Sound aktiv/Monochrome Detect MFP-Int15 ($13C) und Timer-A MFP-Int13 ($134)
  ausgelesen und als Sprungziel eingetragen. Nach einem Bufferdurchlauf wird dann
  dorthin gesprungen. Es wird also quasi "kÅnstlich" ein Interrupt erzeugt. 
  Ob Åber den MFP-INT15 oder den TIMER-A-Interrupt MFP-INT13 gesprungen wird,
  kann man wie Åblich mit setinterrupt einstellen.
  Wichtig ist auch, das der Timer-A NICHT als Counter fÅr die BufferdurchlÑufe verwendet
  bzw. programmiert werden kann. Das muû man nun mit einem eigenen Counter, den man
  entsprechend hochzÑhlt, machen. Auûerdem ist es wichtig, das man NICHT die Interrupts
  des MFP freigibt ! Diesen Teil kann man in den Programmen weglassen. 
  Es ist bisher nicht mîglich, die Interrupts gemischt einzusetzen, also z.B. Timer-A fÅr
  Record und MFP-Int fÅr Play. Ich bin mir auch noch nicht ganz sicher, ob der Falcon
  diese gemischte Betriebsart unterstÅtzt. Der setinterrupt-Aufruf lÑût dies prinzipiell zu.
  setinterrupt lÑût auch ein Auslîsen beider Ints an einem play/record-Bufferende zu.
  Wie das funktionieren soll, ist mir allerdings ein RÑtsel. Ich gehe daher davon aus,
  das es auf dem Falcon keinen gemischten Betrieb der Ints gibt.

- buffoper: wird unterstÅtzt. Der Stereomodus funktioniert. Der spezielle Vierkanalmodus
  bei dem die Aufnahme und Wiedergabe Åber die digitalen und analogen AnschlÅsse parallel
  erfolgt, wird noch nicht unterstÅtzt, die eigenen XBIOS-Funktionen hierfÅr funktionieren
  aber. Der Achtkanalmodus ist eingebunden aber noch nicht getestet. Das hole ich in den
  nÑchsten Tagen nach. Der 16Kanal-Modus wird auch noch nicht unterstÅtzt, nur mit den
  eigenen XBIOS-Funktionen derzeit mîglich. Zur Umschaltung der Aufnahme- und Wiedergabemodi
  der Startrack-Karte siehe die XBIOS-Doku, Funktionen recmode(26) und playmode(27).

- dsptristate: ist eingebunden, ich weiû allerdings nicht genau ob es richtig gemacht wurde.
  dspxmit: koppelt die DSP-Leitungen SC1 und SC2 von der Matrix an/ab.
  dsprec:  koppelt die DSP-Leitungen SC0 und SRD von der Matrix an/ab.

  Die Gefahr von KurzschlÅssen besteht nicht, da die SRD-Leitung entsprechend
  abgekoppelt wird. Die STD-Leitung wird nicht abgekoppelt, da die Matrix in der StarTrack
  so realisiert ist,das auf dieser Leitung nur Daten vom DSP empfangen und NICHT gesendet werden
  und daher die Gefahr eines Kurzschlusses nicht gegeben ist. Die STD-Leitung ist nur ein 
  Matrix-Eingang von vielen und kann wahlweise die DSP-Outputdaten,RDATA vom DSP-Port oder
  die Matrix-Outputdaten zum Matrix-Input befîrdern. Siehe dazu auch die entsprechende
  Matrix-Zeichnung MATRIX.IMG, da die Matrix der StarTrack etwas anders funktioniert. 
  HardwaremÑûig kînnen die Leitungen SRD,SC0,SC1 und SC2 des DSP
  einzeln abgekoppelt bzw. mit der Matrix verbunden werden.
 
  
- gpio: wird voll unterstÅtzt.
  Dabei erfolgt die Taktumschaltung vollautomatisch nach der Soundpool-Spezifikation
  
- devconnect: Die Connection-Matrix wird voll unterstÅtzt mit den EinschrÑnkungen der
              Matrixrealisierung in Startrack- und DSP-Erweiterung. Siehe dazu auch
              die Matrix-Zeichnung die ihr von mir bekommen habt.
              
              srcclk: wird voll unterstÅtzt und ist zum Teil erweitert. Die Taktraten sind teilweise
              auch etwas anders als im Falcon.
              
              0 - Interne Taktraten der Startrack-Karte, Taktrateneinbindung wie bei XBIOS-Funktion
                  sclock(23) beschrieben
                  
              1 - Externen Takt benutzen. Das ist der Takt der Åber den DSP-Port EXCLK-Anschluû eingespeist wird.
                  Dabei spielen die GPIO-Bits des DSP-Ports eine wichtige Rolle: Diese werden nach den Soundpool-
                  Spezifikationen interpretiert:
                  GPIO2=0 -> SP/DIF (dabei wird die interne SP/DIF angesprochen)
                  GPIO2=1 -> ADAT (Samplerate kommt von ADAT-PLL Åber den EXCLK-Input)
                  GPIO1=0 -> SP/DIF pll (Samplerate kommt von Digital-In)
                  GPIO1=1 -> SP/DIF quartzgeneriert (Samplerate abhÑngig von GPIO0)
                  GPIO0=0 -> 44.1 kHz quartzgeneriert
                  GPIO0=1 -> 48 kHz quartzgeneriert

              2 - Erweiterte CLKDIV-Teiler auf der DSP-Karte in Verbindung mit dem Externen Takt 
                  nutzen. Dadurch sind 60 zusÑtzliche Taktraten mîglich ! Siehe dazu auch XBIOS-Funktion
                  clkdivide. Hier die Auflistung der Taktraten:
                  
                   0..14 -> extclock/256/x     x=0..14
                  15..29 -> extclock/384/x     x=0..14
                  30..44 -> extclock/512/x     x=0..14
                  45..59 -> extclock/768/x     x=0..14
                  
              3 - Falcon-kompatible Taktraten durch externes 25.175 MHZ-Clockmodul und CLKDIV-Teiler auf DSP-Karte.
                  Die Taktraten werden entsprechend den devconnect->prescale Definitionen erzeugt.
                  Im Unterschied zum Falcon kînnen alle Sampleraten mit dem A/D und D/A-Wandler genutzt werden.
                  Da es teilweise erhebliche Fehler in den verschiedenen Dokus gibt, hier die einzig wahre:
                  
                   0 -> digital pll (es gibt keinen STE-mode)
                   1 -> 49170 Hz
                   2 -> 32780 Hz
                   3 -> 24585 Hz
                   4 -> 19668 Hz
                   5 -> 16390 Hz
                   6 -> 14049 Hz
                   7 -> 12292 Hz
                   8 -> 10927 Hz
                   9 -> 9834 Hz
                  10 -> 8940 Hz
                  11 -> 8195 Hz
                  12 -> 7565 Hz
                  13 -> 7024 Hz
                  14 -> 6556 Hz
                  15 -> n.c. (bei Falcon 6146 Hz)
              
              Die Funktionsnummern 0 und 3 kînnen durch die XBIOS-Funktion extclkmode(75) vertauscht werden.
              Dann hat man unter der Original-Funktionsnummer 0 wirklich die Falcon-kompatiblen Taktraten.
              Die zusÑtzlichen Taktraten der Startrack-Karte liegen dann auf Funktionsnummer 3.
              
              clkfalcon: XBIOS 500,75,wert = 0 - kein externes 25.175 MHz-Clockmodul vorhanden 
                                             1 - externes 25.175 MHz-Clockmodul vorhanden
                     
              prescale: wird voll unterstÅtzt, liefert zum Teil aber andere Taktraten als der Falcon, je
                        nach ausgewÑhltem srcclk-modus (siehe oben).                        
                        
              protocol: wird nicht unterstÅtzt. Es gibt nur einen Modus, da die Hardware
                        der Audiokarte immer mit Handshaking arbeitet. Ist der Rechner aber
                        zu langsam um die Datenpakete rechtzeitig abzuholen,
                        kînnen durchaus Daten bei der öbertragung verlorengehen. 
                        
- sndstatus: wird teilweise unterstÅtzt. Bei öbersteuerung werden die öberlaufbits gesetzt und durch
             auslesen von sndstatus wieder zurÅckgesetzt. Noch nicht getestet ob die Verhaltensweise
             beim Falcon gleich ist. Ich denke aber, es ist so.
             Die Bits fÅr ungÅltiges Kontrollfeld,ungÅltiges Sync-Format und ungÅltiger Takt
             werden nicht unterstÅtzt, da die Hardware hierfÅr keine Informationen liefert.
             Auch reset(1) wird unterstÅtzt. Dabei wird das Soundsystem komplett zurÅckgesetzt,
             so wie es nach dem Start der XBIOS-Erweiterung initialisiert war. Die Behandlung
             ist allerdings noch nicht genau gleich wie im Falcon. Hier wird in Zukunft der
             Resetvorgang an den Falcon angepaût.
             Die Erkennung der FDI-Erweiterung durch $4711 ist bereits eingebaut, d.h. das
             Vorhandensein einer FDI-Erweiterung wird vorgespielt. Es sind ja bereits SP/DIF
             Ein- und AusgÑnge auf der Karte vorhanden.
             
- buffptr: wird voll unterstÅtzt.

Alle DSP-spezifischen XBIOS-Funktionen die mit DSP_... beginnen sind nun implementiert
und wurden von MagiC for Falcon fÅr die StarTrack-Audiokarte portiert.

Direkte Zugriffe auf Falcon Hardware-Register werden NICHT abgefangen !

Der DSP ist ab Adresse $FEFF0600 zu erreichen. Durch das Hades bzw. Medusa MMU-Accessorie
werden diese in den Falcon-Adressraum eingeblendet ($FFA200).
Das gleiche ist prinzipiell auch auf dem TT machbar, der Treiber dafÅr ist aber noch nicht erhÑltlich.
Die DSP-Register kînnen nur Byteweise angesprochen werden. Word- und Longword-Zugriffe
sind nicht mîglich ! Der Falcon setzt diese wohl in 8Bit-Zugriffe um. Das ist jedoch
fÅr die Startrack-Realisierung zu aufwendig gewesen und daher weggefallen. Der DSP
hat nur einen 8Bit Hostport, auch im Falcon ist das so.

FÅr die DSP-Programmierung im 2Kanal- und 8Kanal-Modus sollte man sich die beigefÅgten
DSP-Beispielsourcen anschauen.

ENDE

              
               
              

